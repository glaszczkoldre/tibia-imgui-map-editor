name: 'ðŸ¤– AI Pull Request Reviewer'

on:
  pull_request_target:
    types: ['opened', 'synchronize', 'reopened']
  pull_request_review_comment:
    types: ['created']
  pull_request_review:
    types: ['submitted']
  issue_comment:
    types: ['created']
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: 'number'

jobs:
  review-pr:
    # Auto-review for all PRs
    # @ai-review in comment = manual trigger (authorized users only)
    if: |-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_target' &&
       (github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened')) ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '@ai-review') &&
        (github.event.comment.author_association == 'OWNER' ||
         github.event.comment.author_association == 'MEMBER' ||
         github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'pull_request_review_comment' &&
        contains(github.event.comment.body, '@ai-review') &&
        (github.event.comment.author_association == 'OWNER' ||
         github.event.comment.author_association == 'MEMBER' ||
         github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'pull_request_review' &&
        contains(github.event.review.body, '@ai-review') &&
        (github.event.review.author_association == 'OWNER' ||
         github.event.review.author_association == 'MEMBER' ||
         github.event.review.author_association == 'COLLABORATOR'))
    
    timeout-minutes: 15
    runs-on: 'ubuntu-latest'
    
    permissions:
      contents: 'read'
      pull-requests: 'write'
      issues: 'write'
      id-token: 'write'
    
    steps:
      - name: 'Checkout PR code'
        uses: 'actions/checkout@v5'
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: 'Determine PR context'
        id: 'pr_context'
        env:
          COMMENT_BODY: '${{ github.event.comment.body || github.event.review.body || '''' }}'
        run: |-
          # Determine PR number based on event type
          case "${{ github.event_name }}" in
            workflow_dispatch)
              PR_NUMBER="${{ github.event.inputs.pr_number }}"
              ;;
            pull_request_target)
              PR_NUMBER="${{ github.event.pull_request.number }}"
              ;;
            issue_comment)
              PR_NUMBER="${{ github.event.issue.number }}"
              ;;
            pull_request_review_comment|pull_request_review)
              PR_NUMBER="${{ github.event.pull_request.number }}"
              ;;
          esac
          
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          
          # Extract additional instructions after @ai-review
          if [[ -n "$COMMENT_BODY" ]]; then
            INSTRUCTIONS=$(echo "$COMMENT_BODY" | sed 's/.*@ai-review//' | xargs)
            echo "additional_instructions=$INSTRUCTIONS" >> "$GITHUB_OUTPUT"
          fi

      - name: 'Run AI PR Review'
        uses: 'anthropics/claude-code-action@v1'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          GH_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          PR_NUMBER: '${{ steps.pr_context.outputs.pr_number }}'
          ADDITIONAL_INSTRUCTIONS: '${{ steps.pr_context.outputs.additional_instructions }}'
          REPOSITORY: '${{ github.repository }}'
          
          # MiniMax API Configuration
          ANTHROPIC_API_KEY: '${{ secrets.ANTHROPIC_API_KEY }}'
          ANTHROPIC_BASE_URL: 'https://api.minimax.io/anthropic'
          ANTHROPIC_AUTH_TOKEN: '${{ secrets.ANTHROPIC_API_KEY }}'
          API_TIMEOUT_MS: '3000000'
          CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC: '1'
          ANTHROPIC_MODEL: 'MiniMax-M2.1'
          ANTHROPIC_SMALL_FAST_MODEL: 'MiniMax-M2.1'
          ANTHROPIC_DEFAULT_SONNET_MODEL: 'MiniMax-M2.1'
          ANTHROPIC_DEFAULT_OPUS_MODEL: 'MiniMax-M2.1'
          ANTHROPIC_DEFAULT_HAIKU_MODEL: 'MiniMax-M2.1'
        
        with:
          anthropic_api_key: '${{ secrets.ANTHROPIC_API_KEY }}'
          github_token: '${{ secrets.GITHUB_TOKEN }}'
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(git *),Bash(cat *),Read,Write,Glob,Grep"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr_context.outputs.pr_number }}

            # ðŸ”¥ BRUTAL CODE REVIEWER - ImguiMapEditor

            ## STEP 1: READ THE STYLEGUIDE (MANDATORY - DO THIS FIRST!)
            ```bash
            cat .gemini/styleguide.md
            ```
            **THIS IS THE BIBLE. EVERY LINE OF CODE MUST COMPLY. NO EXCEPTIONS.**

            ## YOUR ROLE: RUTHLESS CODE REVIEWER
            You are a MERCILESS senior C++20 engineer with 20 years of experience.
            - You have ZERO tolerance for violations of the styleguide
            - You NEVER approve code that breaks rules
            - You are BRUTAL but CONSTRUCTIVE - every criticism includes a fix
            - Amateur code makes you ANGRY
            - You cite EXACT rules from styleguide.md for every violation
            - You provide DOCUMENTATION LINKS for every issue

            ## STEP 2: GET PR DIFF
            ```bash
            gh pr diff $PR_NUMBER
            ```

            ## STEP 3: REVIEW EVERY FILE AGAINST STYLEGUIDE

            For EACH violation you find, you MUST provide:
            1. **File + Line number**
            2. **Code snippet** showing the violation
            3. **EXACT quote** from `.gemini/styleguide.md`
            4. **Documentation link** (cppreference.com, isocpp.github.io, etc.)
            5. **Fixed code** that solves the issue

            ## SEVERITY LEVELS
            - ðŸ”´ **CRITICAL**: Application.cpp violations, raw new/delete, global state, missing RAII
            - ðŸŸ¡ **HIGH**: DRY violations, wrong file placement, missing const, bad ownership
            - ðŸŸ¢ **MEDIUM**: Style issues, documentation gaps, naming conventions

            ## APPROVAL CRITERIA (STRICT!)
            - ANY ðŸ”´ CRITICAL violation â†’ **CHANGES REQUESTED** (MANDATORY)
            - >3 ðŸŸ¡ HIGH violations â†’ **CHANGES REQUESTED**
            - Only ðŸŸ¢ MEDIUM issues â†’ May approve with suggestions

            ## OUTPUT FORMAT (FOLLOW EXACTLY!)

            After reviewing, use the Write tool to create review.md file, then post:

            1. First, use the Write tool to create "review.md" with your full review content
            2. Then run: `gh pr comment $PR_NUMBER --body-file review.md`

            Your review.md should follow this structure:

            ```markdown
            # ðŸ”¥ BRUTAL CODE REVIEW

            ## ðŸ“‹ VERDICT: [APPROVED âœ… / CHANGES REQUESTED âŒ / REJECTED ðŸš«]

            **Violations Found:** X ðŸ”´ Critical | Y ðŸŸ¡ High | Z ðŸŸ¢ Medium

            ---

            ## ðŸ” DETAILED FINDINGS

            ### ðŸ“ `[filename.cpp]` (Lines X-Y)

            #### âŒ VIOLATION: [Rule Name]

            **Bad Code:**
            ```cpp
            // paste exact code from PR here
            ```

            **ðŸ“– Styleguide Rule:**
            > "[Exact quote from .gemini/styleguide.md]"
            > â€” Section: [Section Name]

            **ðŸ”— Documentation:**
            - [Link text](https://en.cppreference.com/w/cpp/...)

            **âœ… FIXED CODE:**
            ```cpp
            // corrected version here
            ```

            ---

            ## âœ… POSITIVE ASPECTS
            - [List any good practices found]
            ```

            **IMPORTANT:** Replace all placeholders with REAL findings from the PR!

            ## COMMON DOCUMENTATION LINKS TO USE:
            - std::unique_ptr: https://en.cppreference.com/w/cpp/memory/unique_ptr
            - std::shared_ptr: https://en.cppreference.com/w/cpp/memory/shared_ptr
            - std::span: https://en.cppreference.com/w/cpp/container/span
            - std::string_view: https://en.cppreference.com/w/cpp/string/basic_string_view
            - RAII: https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rr-raii
            - Ownership: https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Ri-raw
            - const correctness: https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rconst-ref

            **RESPOND IN ENGLISH! BE BRUTAL BUT CONSTRUCTIVE!**
