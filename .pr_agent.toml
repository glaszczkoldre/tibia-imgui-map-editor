# =============================================================================
# Qodo Merge (PR-Agent) Configuration
# =============================================================================
# This file configures the AI-powered PR reviewer for a C++ ImGui/OpenGL project.
# Documentation: https://qodo-merge-docs.qodo.ai/
# =============================================================================


# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
[config]
# Model configuration (using OpenAI-compatible endpoint via MiniMax)
# Note: The model is set via workflow env vars, but we set fallbacks here
model = "openai/MiniMax-M2.1"
fallback_models = ["openai/MiniMax-M2.1"]

# REQUIRED: Set max tokens for custom model (MiniMax-M2.1 supports 128K context)
custom_model_max_tokens = 128000

# Dynamic context pulls additional file context when analyzing changes
allow_dynamic_context = true

# Use "high" reasoning effort for thorough, deep analysis
reasoning_effort = "high"

# Automatically detect push events and run the configured pr_commands
handle_push_trigger = true

# Automatically read QODO.MD from repo root for project conventions
# PR-Agent auto-detects: AGENTS.MD, QODO.MD, CLAUDE.MD in root directory
add_repo_metadata = true

# Ignore files that aren't relevant to code review
patch_extension_skip_types = [".md", ".txt", ".json", ".yml", ".yaml", ".toml", ".ini", ".cfg"]




# -----------------------------------------------------------------------------
# PR Reviewer (/review)
# -----------------------------------------------------------------------------
[pr_reviewer]
# Add labels indicating security concerns and estimated review effort
enable_review_labels_security = true
enable_review_labels_effort = true

# Run review even if the PR only contains test files
require_review_during_tests = true

# Maximum number of issues to report
num_max_findings = 10

# Disable persistent comment (create new comments instead of updating)
persistent_comment = false

# Show help text in review output
enable_help_text = true

# Always post final update message when review is complete
final_update_message = true

# C++ and OpenGL focused review instructions
extra_instructions = """
You are a STRICT code reviewer for a C++ ImGui/OpenGL map editor project.
Your primary reference is `.gemini/styleguide.md` - all rules there are mandatory.

=== LANGUAGE: C++17/20 ===
This is a modern C++ project. Focus on:
- RAII for ALL OpenGL resources (VAO, VBO, Shader, Texture)
- Smart pointers (std::unique_ptr, std::shared_ptr) not raw new/delete
- std::span instead of pointer+size pairs
- std::string_view for read-only string parameters
- const-correctness on all methods that don't modify state
- C++20 concepts/requires where applicable

=== CRITICAL VIOLATIONS (REJECT IMMEDIATELY) ===
1. Application.cpp Pollution:
   - This file is ONLY for initialization and main loop
   - ANY business logic = REJECT

2. Manual Resource Management:
   - glGen*/glDelete* without RAII wrapper = REJECT
   - raw new/delete instead of smart pointers = REJECT

3. Architecture Violations:
   - New features MUST go in src/modules/ or src/ui/
   - Utility functions go in src/utils/ or src/common/
   - Never dump code in random existing files

4. Duplicate Code:
   - Copy-pasted logic = REJECT
   - Demand shared utilities

=== REVIEW STYLE ===
- Be specific: cite line numbers and code snippets
- Do NOT be polite about architecture violations
- Reference .gemini/styleguide.md sections when explaining issues
"""


# -----------------------------------------------------------------------------
# PR Description (/describe)
# -----------------------------------------------------------------------------
[pr_description]
# Let AI generate a descriptive title based on changes
generate_ai_title = true

# Add classification labels to the PR (e.g., "Bug fix", "Enhancement")
publish_labels = true

# Post the AI-generated description as a comment (preserves original description)
publish_description_as_comment = true

# Add a visual diagram showing file/component relationships
enable_pr_diagram = true

# Use bullet points for cleaner formatting
use_bullet_points = true

# Include PR type classification
enable_pr_type = true

# Add original user description to AI output
add_original_user_description = true

# Always post final update message
final_update_message = true


# -----------------------------------------------------------------------------
# Code Suggestions (/improve)
# -----------------------------------------------------------------------------
[pr_code_suggestions]
# Allow creating commits directly from suggestions
commitable_code_suggestions = true

# Maximum suggestions per code chunk (large PRs get chunked)
num_code_suggestions_per_chunk = 10

# Total number of suggestions to generate
num_code_suggestions = 8

# Only suggest fixes for real problems, skip stylistic nitpicks
focus_only_on_problems = true

# Filter out low-confidence suggestions (0-10 scale, 7+ = high quality)
suggestions_score_threshold = 7

# Use the improved scoring/ranking mechanism for self-reflection
new_score_mechanism = true
new_score_mechanism_th_high = 9
new_score_mechanism_th_medium = 7

# NEVER auto-approve PRs - always require human review
approve_pr_on_self_review = false

# Auto-extended mode for deeper analysis
auto_extended_mode = true

# Maximum API calls for large PRs
max_number_of_calls = 3
parallel_calls = true

# Create new comments instead of updating (disabled persistent)
persistent_comment = false

# Always show output even if no suggestions
publish_output_no_suggestions = true

# C++ specific improvement instructions
extra_instructions = """
Focus on C++ best practices:
- Memory safety and RAII patterns
- Smart pointer usage (unique_ptr, shared_ptr)
- const-correctness
- Modern C++ features (span, string_view, concepts)
- OpenGL resource management
- Proper header organization and forward declarations
"""


# -----------------------------------------------------------------------------
# Documentation (/add_docs)
# -----------------------------------------------------------------------------
[pr_add_docs]
# Use Google-style docstrings (compatible with Doxygen)
docs_style = "Google"


# -----------------------------------------------------------------------------
# Changelog (/update_changelog)
# -----------------------------------------------------------------------------
[pr_update_changelog]
# Allow the agent to commit changelog updates directly
push_changelog_changes = true

# Add link back to PR in changelog
add_pr_link = true

# Skip CI when pushing changelog changes
skip_ci_on_push = true


# -----------------------------------------------------------------------------
# Questions (/ask)
# -----------------------------------------------------------------------------
[pr_questions]
# Use conversation history for context in follow-up questions
use_conversation_history = true


# -----------------------------------------------------------------------------
# Test Generation (/test)
# -----------------------------------------------------------------------------
[pr_test]
# Number of tests to generate
num_tests = 3

# Prefer real objects over mocks when possible
avoid_mocks = true

# C++ testing framework
testing_framework = "GoogleTest"


# -----------------------------------------------------------------------------
# Custom Prompt (/custom_prompt) ðŸ’Ž
# Scans PR and generates suggestions based on custom prompt
# -----------------------------------------------------------------------------
[pr_custom_prompt]
# Custom reviewing prompt focused on C++ architecture
prompt = """\
The code suggestions should focus on the following:
- Verify RAII is used for all OpenGL resources (VAO, VBO, Shader, Texture)
- Check that std::unique_ptr/shared_ptr are used instead of raw new/delete
- Ensure no business logic is added to Application.cpp
- Look for duplicate code that should be refactored to shared utilities
- Verify const-correctness on all methods
- Check for proper use of std::span and std::string_view
"""

# Number of suggestions per chunk
num_code_suggestions_per_chunk = 5

# Show help text
enable_help_text = true


# -----------------------------------------------------------------------------
# Similar Code Search (/similar_code) ðŸ’Ž
# Find similar code in organization or open-source
# -----------------------------------------------------------------------------
[pr_similar_code]
# Search within organization codebase
search_from_org = false

# Number of keywords for search
number_of_keywords = 5

# Maximum results to show
number_of_results = 5


# -----------------------------------------------------------------------------
# Component Improvement (/improve_component) ðŸ’Ž
# Generate suggestions for specific components
# -----------------------------------------------------------------------------
[pr_improve_component]
# Number of suggestions per component
num_code_suggestions = 5


# -----------------------------------------------------------------------------
# Static Analysis (/analyze) ðŸ’Ž
# Interactive component analysis with tests, docs, suggestions
# -----------------------------------------------------------------------------
[pr_analyze]
# Enable interactive checkboxes for component analysis
enable_help_text = true
